apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: java-springboot
  title: Spring Boot Microservice
  description: Create a new Spring Boot microservice with Hexagonal Architecture
  tags:
    - spring-boot
    - java
    - hexagonal
    - microservice
    - jpa
    - mvc
spec:
  owner: platform-team
  type: service
  
  parameters:
    - title: Informaci√≥n del Componente
      required:
        - component_id
        - owner
        - system
      properties:
        component_id:
          title: Nombre del Componente
          type: string
          description: Identificador √∫nico del componente (ej. user-service)
          pattern: '^[a-z0-9-]+$'
          ui:autofocus: true
          ui:help: 'Usar kebab-case: min√∫sculas y guiones'
        description:
          title: Descripci√≥n
          type: string
          description: Descripci√≥n breve del servicio
          ui:widget: textarea
          ui:options:
            rows: 3
        owner:
          title: Propietario
          type: string
          description: Nombre del propietario del componente
          default: Platform Team
        email:
          title: Email del Propietario
          type: string
          description: Email de contacto del propietario
          format: email
          default: platform@example.com
        system:
          title: Sistema
          type: string
          description: Sistema al que pertenece el componente
          ui:field: EntityPicker
          ui:options:
            allowedKinds:
              - System
            defaultKind: System
        lifecycle:
          title: Ciclo de Vida
          type: string
          description: Estado del ciclo de vida del componente
          default: experimental
          enum:
            - experimental
            - production
            - deprecated
          enumNames:
            - 'Experimental - En desarrollo'
            - 'Production - En producci√≥n'
            - 'Deprecated - Obsoleto'
        version:
          title: Versi√≥n
          type: string
          description: Versi√≥n inicial del proyecto
          default: "1.0.0"
          pattern: '^\d+\.\d+\.\d+$'
        tags:
          title: Etiquetas
          type: array
          description: Etiquetas para clasificar el componente
          items:
            type: string
          default:
            - spring-boot
            - java
            - hexagonal
            - microservice
            - jpa
            - mvc
          ui:options:
            orderable: false
    
    - title: Configuraci√≥n Java
      required:
        - groupId
        - artifactId
        - serviceName
      properties:
        groupId:
          title: Group ID
          type: string
          description: Group ID de Maven (ej. com.example)
          default: com.example
        artifactId:
          title: Artifact ID
          type: string
          description: Artifact ID de Maven
          default: service
        serviceName:
          title: Service Name
          type: string
          description: Nombre del servicio para paquetes Java (ej. userservice)
          default: userservice
          pattern: '^[a-z][a-z0-9]*$'
          ui:help: 'Solo min√∫sculas sin guiones ni espacios'
        javaVersion:
          title: Versi√≥n de Java
          type: string
          description: Versi√≥n de Java a utilizar
          default: "21"
          enum:
            - "17"
            - "21"
        springBootVersion:
          title: Versi√≥n de Spring Boot
          type: string
          description: Versi√≥n de Spring Boot
          default: "3.2.5"
          enum:
            - "3.2.5"
            - "3.3.0"
    
    - title: Configuraci√≥n de Base de Datos
      required:
        - database
      properties:
        database:
          title: Base de Datos
          type: string
          description: Motor de base de datos
          default: PostgreSQL
          enum:
            - PostgreSQL
            - MySQL
            - H2
        enableLiquibase:
          title: Habilitar Liquibase
          type: boolean
          description: Usar Liquibase para migraciones
          default: true
    
    - title: Caracter√≠sticas Adicionales
      properties:
        enableSwagger:
          title: Habilitar Swagger/OpenAPI
          type: boolean
          description: Documentaci√≥n API con SpringDoc
          default: true
        enableActuator:
          title: Habilitar Spring Actuator
          type: boolean
          description: Endpoints de monitoreo y salud
          default: true
        enableSecurity:
          title: Habilitar Spring Security
          type: boolean
          description: Seguridad y autenticaci√≥n
          default: false
        coverageThreshold:
          title: Umbral de Cobertura
          type: number
          description: Porcentaje m√≠nimo de cobertura de c√≥digo
          default: 85
          minimum: 0
          maximum: 100
    
    - title: CI/CD y DevOps
      properties:
        enableGithubActions:
          title: Habilitar GitHub Actions
          type: boolean
          description: Pipeline CI/CD con GitHub Actions
          default: true
        enableDocker:
          title: Habilitar Docker
          type: boolean
          description: Dockerfile y docker-compose
          default: true
        environments:
          title: Ambientes
          type: array
          description: Ambientes de despliegue
          default:
            - local
            - develop
            - test
            - staging
            - prod
          items:
            type: string
    
    - title: Repositorio
      required:
        - repoUrl
      properties:
        repoUrl:
          title: URL del Repositorio
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com
            allowedOwners:
              - addon-ai

  steps:
    - id: fetch
      name: Fetch Skeleton
      action: fetch:template
      input:
        url: ./skeleton
        values:
          component_id: ${{ parameters.component_id }}
          description: ${{ parameters.description }}
          owner: ${{ parameters.owner }}
          email: ${{ parameters.email }}
          version: ${{ parameters.version }}
          groupId: ${{ parameters.groupId }}
          artifactId: ${{ parameters.artifactId }}
          javaVersion: ${{ parameters.javaVersion }}
          springBootVersion: ${{ parameters.springBootVersion }}
          serviceName: ${{ parameters.component_id | replace("-", "") }}
          database: ${{ parameters.database }}
          enableLiquibase: ${{ parameters.enableLiquibase }}
          enableSwagger: ${{ parameters.enableSwagger }}
          enableActuator: ${{ parameters.enableActuator }}
          enableSecurity: ${{ parameters.enableSecurity }}
          coverageThreshold: ${{ parameters.coverageThreshold }}
          enableGithubActions: ${{ parameters.enableGithubActions }}
          enableDocker: ${{ parameters.enableDocker }}
          environments: ${{ parameters.environments }}
          application_name: ${{ parameters.component_id | replace("-", "_") }}
          database_name: ${{ (parameters.component_id | replace("-", "_")) + "_db" }}
          port: 8080

    - id: publish
      name: Publish to GitHub
      action: publish:github
      input:
        allowedHosts: ['github.com']
        description: ${{ parameters.description }}
        repoUrl: ${{ parameters.repoUrl }}
        repoVisibility: private
        defaultBranch: main
        gitAuthorName: Backstage Scaffolder
        gitAuthorEmail: scaffolder@backstage.io

    - id: register
      name: Register Component
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps.publish.output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'
    
    - id: create-pr-develop
      name: Create Pull Request to Develop
      action: publish:github:pull-request
      if: ${{ parameters.enableGithubActions }}
      input:
        repoUrl: ${{ parameters.repoUrl }}
        branchName: feature/initial-setup
        targetBranchName: develop
        title: 'feat: Initial project setup from Backstage'
        description: |
          ## üéâ Initial Project Setup
          
          This PR contains the initial project structure generated by Backstage.
          
          ### üèõÔ∏è Architecture
          - **Pattern:** Hexagonal Architecture (Ports and Adapters)
          - **Framework:** Spring Boot ${{ parameters.springBootVersion }} with springBoot
          - **Java Version:** ${{ parameters.javaVersion }}
          
          ### üì¶ Components
          - **Domain Layer:** Business logic and entities
          - **Application Layer:** Use cases and ports
          - **Infrastructure Layer:** Adapters and configurations
          
          ### üõ†Ô∏è Features
          - Database migrations with Liquibase: ${{ parameters.enableLiquibase }}
          - API documentation with Swagger: ${{ parameters.enableSwagger }}
          - Monitoring with Actuator: ${{ parameters.enableActuator }}
          - Code coverage threshold: ${{ parameters.coverageThreshold }}%
          
          ### üöÄ Next Steps
          1. Review the generated code structure
          2. Configure environment variables
          3. Run tests: `mvn test`
          4. Start application: `mvn spring-boot:run`

  output:
    links:
      - title: Repository
        url: ${{ steps.publish.output.remoteUrl }}
      - title: Open in catalog
        icon: catalog
        entityRef: ${{ steps.register.output.entityRef }}
      - title: Pull Request
        url: ${{ steps['create-pr-develop'].output.remoteUrl }}
        if: ${{ parameters.enableGithubActions }}
